<!DOCTYPE html>
<html>
<head>
  <title>Camera Sender</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto; }
    video { background: #000; width: 100%; margin: 10px 0; }
    .share-options { display: flex; gap: 20px; margin-top: 15px; }
    .copy-section, .qr-section { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 8px 15px; margin-top: 5px; cursor: pointer; background: #4285f4; color: white; border: none; }
    #qrcode { margin: 10px auto; width: 150px; height: 150px; }
    .hidden { display: none; }
    input { padding: 8px; width: 100%; box-sizing: border-box; }
  </style>
</head>
<body>
  <h1>Camera Sender</h1>
  <video id="localVideo" autoplay muted playsinline></video>
  
  <div id="connectionSection" class="hidden">
    <h3>Share your connection:</h3>
    <div class="share-options">
      <!-- Manual Copy Section -->
      <div class="copy-section">
        <p>1. Copy this ID:</p>
        <input type="text" id="peerId" readonly>
        <button id="copyButton">Copy to Clipboard</button>
      </div>
      
      <!-- QR Code Section -->
      <div class="qr-section">
        <p>2. Scan this QR code:</p>
        <div id="qrcode"></div>
      </div>
    </div>
  </div>

  <button id="startButton">Start Camera</button>

  <script>
    const localVideo = document.getElementById('localVideo');
    const startButton = document.getElementById('startButton');
    const connectionSection = document.getElementById('connectionSection');
    const peerId = document.getElementById('peerId');
    const copyButton = document.getElementById('copyButton');
    const qrDiv = document.getElementById('qrcode');

    startButton.addEventListener('click', async () => {
      try {
        // 1. Start camera
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        localVideo.srcObject = stream;
        startButton.disabled = true;

        // 2. Initialize PeerJS
        const peer = new Peer({
          host: '0.peerjs.com',
          secure: true,
          debug: 3
        });

        peer.on('open', (id) => {
          console.log('Sender ID:', id);
          connectionSection.classList.remove('hidden');
          
          // 3A. Set up manual copy
          peerId.value = id;
          
          // 3B. Generate QR code (FIXED)
          const qr = qrcode(0, 'L');
          qr.addData(`${window.location.origin}/receiver.html#${id}`);
          qr.make();
          qrDiv.innerHTML = qr.createImgTag(4); // Size 4px modules
          
          // 4. Handle receiver connection
          peer.on('connection', (conn) => {
            const call = peer.call(conn.peer, stream);
            call.on('error', err => console.error('Call error:', err));
          });
        });

        peer.on('error', err => console.error('Peer error:', err));

      } catch (err) {
        console.error('Error:', err);
        alert('Error: ' + err.message);
      }
    });

    copyButton.addEventListener('click', () => {
      peerId.select();
      document.execCommand('copy');
      alert('Copied to clipboard!');
    });
  </script>
</body>
</html>